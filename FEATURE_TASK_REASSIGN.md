# 任务重新分配功能

## 功能概述

管理员可以将现有任务重新分配给其他用户，实现灵活的任务管理和工作调配。

## 功能特性

### 1. 重新分配入口
- 在任务详情模态框中添加"重新分配"按钮
- 点击后打开重新分配对话框
- 显示当前任务信息和当前分配用户

### 2. 用户选择
- 下拉列表显示所有普通用户
- 当前分配的用户默认选中
- 可以选择任何其他用户

### 3. 分配记录
- 自动更新任务的所属用户
- 记录分配人（当前管理员）
- 保持任务的其他属性不变

## 使用方法

### 操作流程

```
管理后台
    ↓
任务管理标签
    ↓
点击任务标题
    ↓
任务详情模态框
    ↓
点击"重新分配"按钮
    ↓
重新分配对话框
    ↓
选择新用户
    ↓
点击"确认分配"
    ↓
任务重新分配成功
```

### 详细步骤

1. **打开任务详情**
   - 进入管理后台
   - 切换到"任务管理"标签
   - 点击任意任务标题

2. **开始重新分配**
   - 在任务详情页面
   - 点击"重新分配"按钮
   - 任务详情关闭，重新分配对话框打开

3. **选择新用户**
   - 查看当前任务信息
   - 查看当前分配给谁
   - 从下拉列表选择新用户

4. **确认分配**
   - 点击"确认分配"按钮
   - 等待操作完成
   - 查看成功提示

5. **验证结果**
   - 任务列表自动刷新
   - 查看任务的新分配用户
   - 确认分配成功

## 界面展示

### 任务详情页面
```
┌─────────────────────────────────────┐
│ 任务详情                      [×]   │
├─────────────────────────────────────┤
│ 任务标题： 完成报告                 │
│ 任务描述： ...                      │
│ 分配给：   user1                    │
│ 分配人：   admin                    │
│ ...                                 │
├─────────────────────────────────────┤
│ [重新分配]              [关闭]     │
│  ^^^^^^^^^^                         │
│  新增按钮                            │
└─────────────────────────────────────┘
```

### 重新分配对话框
```
┌─────────────────────────────────────┐
│ 重新分配任务                  [×]   │
├─────────────────────────────────────┤
│ ┌─────────────────────────────────┐ │
│ │ 当前任务：完成报告              │ │
│ │ 当前分配给：user1               │ │
│ └─────────────────────────────────┘ │
│                                     │
│ 重新分配给：                        │
│ ┌─────────────────────────────────┐ │
│ │ user1 (张三)        ▼          │ │
│ │ user2 (李四)                   │ │
│ │ user3 (王五)                   │ │
│ └─────────────────────────────────┘ │
├─────────────────────────────────────┤
│          [取消]    [确认分配]       │
└─────────────────────────────────────┘
```

## 技术实现

### 后端API

#### 端点
```
PUT /api/admin/todos/:id/reassign
```

#### 权限
- 仅管理员可访问
- 检查 session 中的用户角色

#### 请求参数
```json
{
  "userId": 2  // 新用户的ID
}
```

#### 响应
```json
{
  "success": true
}
```

#### 数据库操作
```sql
UPDATE todos 
SET user_id = ?, assigned_by = ? 
WHERE id = ?
```

### 前端实现

#### HTML 结构
```html
<!-- 任务详情中的按钮 -->
<button onclick="adminApp.openReassignModal()">
    重新分配
</button>

<!-- 重新分配模态框 -->
<div id="reassignModal" class="modal">
    <div class="modal-content">
        <div class="reassign-info">
            <p>当前任务：<strong id="reassignTaskTitle"></strong></p>
            <p>当前分配给：<strong id="reassignCurrentUser"></strong></p>
        </div>
        <form id="reassignForm">
            <select id="reassignUserId" required></select>
            <button type="submit">确认分配</button>
        </form>
    </div>
</div>
```

#### JavaScript 逻辑
```javascript
// 打开重新分配对话框
openReassignModal() {
    const task = this.tasks.find(t => t.id === this.currentTaskId);
    // 填充任务信息
    // 填充用户列表
    // 显示模态框
}

// 执行重新分配
async reassignTask(e) {
    e.preventDefault();
    const userId = document.getElementById('reassignUserId').value;
    
    const response = await fetch(
        `/api/admin/todos/${this.currentTaskId}/reassign`,
        {
            method: 'PUT',
            body: JSON.stringify({ userId })
        }
    );
    
    if (response.ok) {
        // 显示成功消息
        // 重新加载任务列表
    }
}
```

## 使用场景

### 场景 1: 工作量调整
```
情况：user1 任务过多，user2 任务较少
操作：将 user1 的部分任务重新分配给 user2
结果：工作量更加平衡
```

### 场景 2: 人员变动
```
情况：user1 请假，需要其他人接手
操作：将 user1 的任务重新分配给 user3
结果：工作不受影响，按时完成
```

### 场景 3: 技能匹配
```
情况：发现任务更适合其他人完成
操作：重新分配给更合适的用户
结果：提高工作效率和质量
```

### 场景 4: 紧急调配
```
情况：紧急任务需要特定人员处理
操作：快速重新分配任务
结果：及时响应紧急情况
```

## 数据变化

### 重新分配前
```javascript
{
    id: 1,
    title: "完成报告",
    user_id: 2,        // user1
    assigned_by: 1,    // admin
    // ... 其他字段
}
```

### 重新分配后
```javascript
{
    id: 1,
    title: "完成报告",
    user_id: 3,        // user2 (新用户)
    assigned_by: 1,    // admin (更新为当前管理员)
    // ... 其他字段保持不变
}
```

## 权限控制

### 管理员权限
- ✅ 可以重新分配任何任务
- ✅ 可以分配给任何普通用户
- ✅ 可以查看分配历史

### 普通用户权限
- ❌ 无法访问重新分配功能
- ❌ 无法看到"重新分配"按钮
- ✅ 可以看到任务被重新分配的结果

## 安全性

### API 安全
- 检查用户登录状态
- 验证管理员权限
- 验证任务存在性
- 验证目标用户存在性

### 数据验证
- 用户ID必须有效
- 目标用户必须是普通用户
- 任务ID必须存在

### 错误处理
- 未登录：返回 401
- 无权限：返回 403
- 参数错误：返回 400
- 任务不存在：返回 404
- 服务器错误：返回 500

## 用户体验

### 视觉反馈
- 按钮悬停效果
- 模态框平滑动画
- 成功/失败提示消息
- 加载状态指示

### 操作便捷性
- 一键打开重新分配
- 当前用户默认选中
- 快速选择新用户
- 自动刷新列表

### 信息清晰
- 显示当前任务信息
- 显示当前分配用户
- 用户列表包含显示名称
- 操作结果明确提示

## 测试要点

### 功能测试
- [ ] 打开重新分配对话框
- [ ] 显示当前任务信息
- [ ] 显示当前分配用户
- [ ] 用户列表正确加载
- [ ] 当前用户默认选中
- [ ] 选择新用户
- [ ] 提交重新分配
- [ ] 显示成功提示
- [ ] 任务列表刷新
- [ ] 验证分配结果

### 权限测试
- [ ] 管理员可以访问
- [ ] 普通用户无法访问
- [ ] 未登录无法访问

### 边界测试
- [ ] 不选择用户提交
- [ ] 选择相同用户
- [ ] 任务不存在
- [ ] 用户不存在
- [ ] 网络错误处理

### UI测试
- [ ] 模态框正确显示
- [ ] 信息正确填充
- [ ] 下拉列表正确显示
- [ ] 按钮样式正确
- [ ] 响应式布局

## 常见问题

### Q: 可以将任务分配给管理员吗？
A: 不可以。下拉列表只显示普通用户（role='user'）。

### Q: 重新分配后原用户还能看到任务吗？
A: 不能。任务会从原用户的列表中消失，出现在新用户的列表中。

### Q: 可以批量重新分配吗？
A: 当前版本不支持。每次只能重新分配一个任务。

### Q: 重新分配会保留任务状态吗？
A: 是的。任务的状态、优先级、描述等都保持不变，只改变所属用户。

### Q: 可以撤销重新分配吗？
A: 可以。再次重新分配回原用户即可。

## 后续改进建议

### 1. 批量重新分配
允许选择多个任务，一次性重新分配给同一用户。

### 2. 分配历史
记录任务的所有分配历史，包括时间和操作人。

### 3. 通知功能
任务被重新分配时，通知新用户和原用户。

### 4. 分配原因
添加备注字段，说明重新分配的原因。

### 5. 智能推荐
根据用户的工作量和技能，推荐最合适的分配对象。

## 总结

任务重新分配功能为管理员提供了灵活的任务管理能力：
- ✅ 快速调整工作分配
- ✅ 应对人员变动
- ✅ 优化资源配置
- ✅ 提高团队效率

---

**功能版本**: 1.0  
**添加日期**: 2026-02-09  
**状态**: ✅ 已完成并测试
